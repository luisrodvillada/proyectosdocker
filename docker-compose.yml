services:

  # ==========================
  # DATABASE (PostgreSQL)
  # ==========================
  backend-db:
    image: postgres:15-alpine
    container_name: backend-db

    # Variables de entorno de la base de datos
    # (POSTGRES_* son usadas por el contenedor postgres)
    env_file:
      - env/dev/.env

    # Persistencia de datos de la base de datos
    volumes:
      - backend-db-data:/var/lib/postgresql/data

    # Reinicio automático si el contenedor cae
    restart: unless-stopped

    # Red interna del proyecto
    networks:
      - mi_red

    # Healthcheck para saber cuándo PostgreSQL acepta conexiones
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s


  # ==========================
  # BACKEND API (Node.js)
  # ==========================
  backend-api:
    build:
      context: ./backend
    image: mi-backend-api:local
    container_name: backend-api

    # Variables de entorno del backend
    # (DB_* y NODE_ENV son usadas por la app)
    env_file:
      - env/dev/.env

    # Volumen solo para desarrollo (logs, datos locales, etc.)
    volumes:
      - ./backend/data:/app/data

    # Reinicio automático
    restart: unless-stopped

    # Red interna
    networks:
      - mi_red

    # No arrancar el backend hasta que la BBDD esté healthy
    depends_on:
      backend-db:
        condition: service_healthy

    # Healthcheck del backend (endpoint real)
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s



  # ==========================
  # FRONTEND WEB (Nginx)
  # ==========================
  web:
    build:
      context: ./frontend
    container_name: web

    # Exponemos el frontend al host
    ports:
      - "8080:80"

    # Reinicio automático
    restart: unless-stopped

    # Red interna
    networks:
      - mi_red

    # No arrancar la web hasta que el backend esté healthy
    depends_on:
      backend-api:
        condition: service_healthy


# ==========================
# VOLUMES
# ==========================
volumes:
  backend-db-data:


# ==========================
# NETWORKS
# ==========================
networks:
  mi_red:
    external: true
